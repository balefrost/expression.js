<!doctype html>
<html>
<head>
    <script src="orderedSet.js"></script>
    <script type="application/javascript">

        var variableOrdering = {
            compare: function(a, b) {
                return a._id < b._id ? -1 : a._id > b._id ? 1 : 0;
            },
            equals: function(a, b) {
                return a._name === b._name && a._id === b._id;
            }
        };

        function ScopeVariable(name, id) {
            this._name = name;
            this._id = id;
        }

        ScopeVariable.prototype.toString = function() {
            return this._name + "$" + this._id;
        };

        function ScopeEntry() {
            this.localVariables = new OrderedSet(variableOrdering);
            this.allVariables = new OrderedSet(variableOrdering);
        }

        ScopeEntry.prototype.makeChild = function() {
            var result = new ScopeEntry();
            result.allVariables = this.allVariables.clone();
            return result;
        };

//        function Builder() {
//            this._counter = 0;
//            this._scopeStack = [new ScopeEntry()];
//        }
//
//        Builder.prototype.allocVariable = function(name) {
//            if (arguments.length === 0) {
//                name = "temp";
//            }
//
//            var head = this._scopeStack[this._scopeStack.length - 1];
//            var variable = new ScopeVariable(name, this._counter);
//            this._counter += 1;
//            head.localVariables.add(variable);
//            head.allVariables.add(variable);
//            return variable;
//        };
//
//        Builder.prototype.functionExpression = function(bodyBuilder) {
//            return this._withScope(function() {
//                var args = [];
//                for (var i = 0; i < bodyBuilder.length; ++i) {
//                    args.push(this.allocVariable("arg"));
//                }
//                var body = bodyBuilder.apply(this, args);
//                return { type: 'functionExpression', arguments: args, body: body };
//            });
//        };
//
//        Builder.prototype._withScope = function(f) {
//            this._scopeStack.push(this._scopeStack[this._scopeStack.length - 1].makeChild());
//            try {
//                return f.call(this);
//            } finally {
//                this._scopeStack.pop();
//            }
//        };
//
//        Builder.prototype.returnStatement = function(expr) {
//            return { type: 'returnStatement', expression: expr };
//        };
//
//        Builder.prototype.identifierReference = function(ident) {
//            var head = this._scopeStack[this._scopeStack.length - 1];
//            if (!head.allVariables.contains(ident)) {
//                throw new Error("The identifier " + ident + " was not found in the current scope");
//            }
//            return { type: 'identifierReferenceExpression', identifier: ident };
//        };
//
//        Builder.prototype.binaryExpression = function(op, left, right) {
//            return { type: 'binaryExpression', operator: op, left: left, right: right };
//        };
//
//        Builder.prototype.addExpression = function() {
//            if (arguments.length < 1) {
//                throw new Error("addExpression requires at least one argument");
//            }
//
//            var expr = arguments[0];
//            for (var i = 1; i < arguments.length; ++i) {
//                expr = this.binaryExpression('+', expr, arguments[i]);
//            }
//            return expr;
//        };
//
//        var bld = new Builder();
//
//        var result = bld.functionExpression(function(a, b, c) {
//           return [
//               bld.returnStatement(bld.addExpression(bld.identifierReference(a), bld.identifierReference(b), bld.identifierReference(c)))
//           ];
//        });

        function cloneKeyset(obj) {
            var result = {};
            var keys = Object.keys(obj);
            for (var i = 0; i < keys.length; ++i) {
                var key = keys[i];
                result[key] = obj[key];
            }
            return result;
        }

        var returnStatementType = 'returnStatement';
        var varStatementType = 'varStatement';
        var ifStatementType = 'ifStatement';
        var exprStatementType = 'exprStatement';
        var functionStatementType = 'functionStatement';
        var binaryExpressionType = 'binaryExpression';
        var numberLiteralExpressionType = 'numberLiteralExpression';
        var stringLiteralExpressionType = 'stringLiteralExpression';
        var functionExpressionType = 'functionExpression';
        var functionCallExpressionType = 'functionCallExpression';
        var identifierReferenceExpressionType = 'identifierReferenceExpression';
        var ternaryExpressionType = 'ternaryExpression';
        var assignmentExpressionType = 'assignmentExpression';
        var memberAccessExpressionType = 'memberAccessExpression';

        function escapeJsString(string) {
            return string.replace(/'"\\/, function(m) {
                switch (m) {
                    case "'":
                        return "\\'";
                    case '"':
                        return '\\"';
                    case '\\':
                        return '\\\\';
                }
            });
        }

        function collectIdentifiers(body, identifierSet) {
            for (var i = 0; i < body.length; ++i) {
                var stat = body[i];
                switch (stat.type) {
                    case 'varStatement':
                        identifierSet[stat.identifier] = true;
                        break;
                    case 'functionStatement':
                        identifierSet[stat.identifier] = true;
                        break;
                }
            }
        }

        function buildFunction(name, parameterNames, body, scopeStack, ioList) {
            var i;
            var innerScope = cloneKeyset(scopeStack[scopeStack.length - 1]);
            for (i = 0; i < parameterNames.length; ++i) {
                innerScope[parameterNames[i]] = true;
            }
            collectIdentifiers(body, innerScope);
            scopeStack.push(innerScope);
            try {
                ioList.push('function');
                if (name) {
                    ioList.push(' ', name);
                }
                ioList.push('(');
                for (i = 0; i < parameterNames.length; ++i) {
                    if (i > 0) {
                        ioList.push(',');
                    }
                    ioList.push(parameterNames[i]);
                }
                ioList.push('){');
                for (i = 0; i < body.length; ++i) {
                    buildStatement(body[i], scopeStack, ioList);
                }
                ioList.push('}');
            } finally {
                scopeStack.pop();
            }
        }

        function buildFunctionCallExpression(functionExpr, args, scopeStack, ioList) {
            ioList.push('(');
            buildExpression(functionExpr, scopeStack, ioList);
            ioList.push(')(');
            for (var i = 0; i < args.length; ++i) {
                if (i > 0) {
                    ioList.push(',');
                }
                buildExpression(args[i], scopeStack, ioList);
            }
            ioList.push(')');
        }

        function buildStatements(statements, scopeStack, ioList) {
            for (var i = 0; i < statements.length; ++i) {
                buildStatement(statements[i], scopeStack, ioList);
                ioList.push(';');
            }
        }

        function buildStatement(stat, scopeStack, ioList) {
            switch (stat.type) {
                case returnStatementType:
                    ioList.push('return ');
                    buildExpression(stat.expression, scopeStack, ioList);
                    ioList.push(';');
                    return;
                case varStatementType:
                    ioList.push('var ', stat.identifier);
                    if (stat.expression) {
                        ioList.push('=');
                        buildExpression(stat.expression, scopeStack, ioList);
                    }
                    ioList.push(';');
                    return;
                case ifStatementType:
                    ioList.push('if(');
                    buildExpression(stat.testExpression, scopeStack, ioList);
                    ioList.push('){');
                    buildStatements(stat.trueBody, scopeStack, ioList);
                    ioList.push('}');
                    if (stat.falseBody) {
                        ioList.push('else{');
                        buildStatements(stat.falseBody, scopeStack, ioList);
                    }
                    return;
                case functionStatementType:
                    buildFunction(stat.identifier, stat.parameterNames, stat.body, scopeStack, ioList);
                    return;
                case exprStatementType:
                    buildExpression(stat.expression, scopeStack, ioList);
                    ioList.push(';');
                    return;
            }
        }

        function buildExpression(expr, scopeStack, ioList) {
            switch (expr.type) {
                case binaryExpressionType:
                    ioList.push('(');
                    buildExpression(expr.left, scopeStack, ioList);
                    ioList.push(')', expr.operator, '(');
                    buildExpression(expr.right, scopeStack, ioList);
                    ioList.push(')');
                    return;
                case numberLiteralExpressionType:
                    ioList.push(expr.value.toString());
                    return;
                case stringLiteralExpressionType:
                    ioList.push('"', escapeJsString(expr.value), '"');
                    return;
                case functionExpressionType:
                    buildFunction('', expr.parameterNames, expr.body, scopeStack, ioList);
                    return;
                case functionCallExpressionType:
                    buildFunctionCallExpression(expr.functionExpr, expr.arguments, scopeStack, ioList);
                    return;
                case identifierReferenceExpressionType:
                    if (!scopeStack[scopeStack.length - 1].hasOwnProperty(expr.identifier)) {
                        throw new Error('The identifier ' + expr.identifier + ' is not defined in this scope.');
                    }
                    ioList.push(expr.identifier);
                    return;
                case memberAccessExpressionType:
                    ioList.push('(');
                    buildExpression(expr.objectExpression, scopeStack, ioList);
                    ioList.push(')[');
                    buildExpression(expr.memberExpression, scopeStack, ioList);
                    ioList.push(']');
                    return;
                case ternaryExpressionType:
                    ioList.push('((');
                    buildExpression(expr.testExpression, scopeStack, ioList);
                    ioList.push(')?(');
                    buildExpression(expr.trueExpression, scopeStack, ioList);
                    ioList.push('):(');
                    buildExpression(expr.falseExpression, scopeStack, ioList);
                    ioList.push('))');
                    return;
                case assignmentExpressionType:
                    if (!scopeStack[scopeStack.length - 1].hasOwnProperty(expr.identifier)) {
                        throw new Error('The identifier ' + expr.identifier + ' is not defined in this scope.');
                    }
                    ioList.push(expr.identifier, '=');
                    buildExpression(expr.expression, scopeStack, ioList);
                    return;
            }
        }

        function build(expr, predefinedIdentifiers) {
            var initialScope = { };
            if (arguments.length === 2) {
                for (var i = 0; i < predefinedIdentifiers.length; ++i) {
                    initialScope[predefinedIdentifiers[i]] = true;
                }
            }
            var ioList = [];
            buildExpression(expr, [initialScope], ioList);
            var str = '(' + ioList.join('') + ')';
            return eval(str);
        }

        function varStatement(identifier, expression) {
            return {
                type: varStatementType,
                identifier: identifier,
                expression: expression
            };
        }

        function ifStatement(testExpr, trueBody, falseBody) {
            return {
                type: ifStatementType,
                testExpression: testExpr,
                trueBody: trueBody,
                falseBody: falseBody
            };
        }

        function functionStatement(identifier, parameterNames, body) {
            return {
                type: functionStatementType,
                identifier: identifier,
                parameterNames: parameterNames,
                body: body
            };
        }

        function returnStatement(expression) {
            return {
                type: returnStatementType,
                expression: expression
            };
        }

        function exprStatement(expression) {
            return {
                type: exprStatementType,
                expression: expression
            };
        }

        function functionExpression(parameterNames, body) {
            return {
                type: functionExpressionType,
                parameterNames: parameterNames,
                body: body
            };
        }

        function functionCallExpression(functionExpr, args) {
            return {
                type: functionCallExpressionType,
                functionExpr: functionExpr,
                arguments: args
            };
        }

        function numberLiteralExpression(value) {
            return {
                type: numberLiteralExpressionType,
                value: value
            };
        }

        function stringLiteralExpression(value) {
            return {
                type: stringLiteralExpressionType,
                value: value
            };
        }

        function identifierReferenceExpression(identifier) {
            return {
                type: identifierReferenceExpressionType,
                identifier: identifier
            };
        }

        function binaryExpression(operator, left, right) {
            return {
                type: binaryExpressionType,
                operator: operator,
                left: left,
                right: right
            };
        }

        function assignmentExpression(identifier, expression) {
            return {
                type: assignmentExpressionType,
                identifier: identifier,
                expression: expression
            };
        }

        function memberAccessExpression(objectExpression, memberExpression) {
            return {
                type: memberAccessExpressionType,
                objectExpression: objectExpression,
                memberExpression: memberExpression
            };
        }

        function ternaryExpression(testExpression, trueExpression, falseExpression) {
            return {
                type: ternaryExpressionType,
                testExpression: testExpression,
                trueExpression: trueExpression,
                falseExpression: falseExpression
            };
        }

        function binaryOperatorChain(name, operator, args) {
            if (args.length === 0) {
                throw new Error(name + ' requires at least one argument');
            }

            var expr = args[0];
            for (var i = 1; i < args.length; ++i) {
                expr = binaryExpression(operator, expr, args[i]);
            }

            return expr;
        }

        function addExpression() {
            return binaryOperatorChain('addExpression', '+', arguments);
        }

        function multiplyExpression() {
            return binaryOperatorChain('multiplyExpression', '*', arguments);
        }

        function memberAccessChain(objectExpr) {
            var result = objectExpr;
            for (var i = 1; i < arguments.length; ++i) {
                result = memberAccessExpression(result, stringLiteralExpression(arguments[i]));
            }
            return result;
        }

        var expr = functionExpression(['a', 'b'],
            [
                varStatement('p'),
                functionStatement('foo', ['x', 'y'], [returnStatement(addExpression(identifierReferenceExpression('x'), identifierReferenceExpression('y')))]),
                varStatement('q', numberLiteralExpression(42)),
                exprStatement(assignmentExpression('p', assignmentExpression('q', numberLiteralExpression(7)))),
                exprStatement(functionCallExpression(memberAccessChain(identifierReferenceExpression('window'), 'console', 'log'), [stringLiteralExpression('message')])),
                returnStatement(multiplyExpression(
                        addExpression(identifierReferenceExpression('a'), identifierReferenceExpression('b')),
                        functionCallExpression(identifierReferenceExpression('foo'), [identifierReferenceExpression('q'), identifierReferenceExpression('p')])))
            ]
        );

        var result = build(expr, ['window']);
        console.log(result(1, 2));

        console.log(result);
    </script>
</head>
</html>